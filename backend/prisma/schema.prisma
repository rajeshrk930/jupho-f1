generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                   @id @default(uuid())
  clerkId            String                   @unique
  email              String                   @unique
  name               String?
  plan               String                   @default("FREE")
  isAdmin            Boolean                  @default(false)
  apiUsageCount      Int                      @default(0)
  lastResetDate      DateTime                 @default(now())
  agentTasksCreated  Int                      @default(0)
  agentLastResetDate DateTime                 @default(now())
  planExpiresAt      DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  adTemplates        AdTemplate[]
  conversations      Conversation[]
  facebookAccount    FacebookAccount?
  messages           Message[]
  payments           Payment[]
  googleSheets       GoogleSheetsConnection?
  leadSubmissions    LeadSubmission[]
  webhookEndpoints   WebhookEndpoint[]
  agentTasks         AgentTask[]
}

model Payment {
  id                String   @id @default(uuid())
  userId            String
  razorpayOrderId   String   @unique
  razorpayPaymentId String?
  amount            Int
  currency          String   @default("INR")
  status            String   @default("PENDING")
  plan              String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  title     String?
  goal      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId, createdAt])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  userId         String
  role           String
  content        String
  feedback       String?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId, createdAt])
}

model FacebookAccount {
  id                String    @id @default(uuid())
  userId            String    @unique
  facebookUserId    String
  facebookUserName  String?
  facebookUserEmail String?
  accessToken       String
  tokenExpiresAt    DateTime
  adAccountId       String
  adAccountName     String?
  pageIds           String?
  pageNames         String?
  csrfToken         String?
  isActive          Boolean   @default(true)
  lastSyncAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adAccountId])
}

model AgentTask {
  id                  String              @id @default(uuid())
  userId              String
  type                String              @default("CREATE_AD")
  status              String              @default("PENDING")
  createdVia          String              @default("AI_AGENT")
  input               String?
  output              String?
  businessProfile     String?
  recommendations     String?
  conversionMethod    String?             @default("lead_form")
  leadFormId          String?
  privacyPolicyUrl    String?
  originalWebsiteUrl  String?
  errorMessage        String?
  conversationState   String?
  fbCampaignId        String?
  fbAdSetId           String?
  fbAdId              String?
  actualCPM           Float?
  actualCTR           Float?
  actualConversions   Int?
  actualSpend         Float?
  impressions         Int?
  clicks              Int?
  performanceGrade    String?
  fbInsightsData      String?
  lastPerformanceSync DateTime?
  createdAt           DateTime            @default(now())
  completedAt         DateTime?
  updatedAt           DateTime            @updatedAt
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedCreatives  GeneratedCreative[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model GeneratedCreative {
  id          String    @id @default(uuid())
  taskId      String
  type        String
  content     String
  isSelected  Boolean   @default(false)
  metadata    String?
  impressions Int?
  clicks      Int?
  conversions Int?
  winRate     Float?
  createdAt   DateTime  @default(now())
  task        AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([type])
}

model AdTemplate {
  id               String   @id @default(uuid())
  userId           String?
  name             String
  category         String?
  description      String?
  isPublic         Boolean  @default(false)
  objective        String
  conversionMethod String   @default("lead_form")
  targeting        String
  budget           String
  adCopy           String
  imageUrl         String?
  usageCount       Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([isPublic])
}

model GoogleSheetsConnection {
  id              String    @id @default(uuid())
  userId          String    @unique
  accessToken     String    // Encrypted with AES-256
  refreshToken    String    // Encrypted with AES-256
  tokenExpiresAt  DateTime
  spreadsheetId   String?
  spreadsheetName String?
  sheetName       String    @default("Leads")
  syncEnabled     Boolean   @default(true)
  lastSyncAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LeadSubmission {
  id              String   @id @default(uuid())
  userId          String
  formId          String   // Facebook lead form ID
  leadId          String   @unique // Facebook lead ID (prevents duplicates)
  data            String   // JSON stringified lead data
  submittedAt     DateTime // When lead was submitted on Facebook
  syncedToSheets  Boolean  @default(false)
  sheetsSyncedAt  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([formId])
  @@index([syncedToSheets])
  @@index([submittedAt])
}

model WebhookEndpoint {
  id          String             @id @default(uuid())
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  url         String             // User's webhook URL
  events      String[]           // ['campaign.created', 'campaign.completed', 'lead.captured']
  secret      String             // Signing secret for HMAC verification
  isActive    Boolean            @default(true)
  description String?            // Optional user description
  
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deliveries  WebhookDelivery[]
  
  @@index([userId])
  @@index([isActive])
}

model WebhookDelivery {
  id           String          @id @default(uuid())
  webhookId    String
  webhook      WebhookEndpoint @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  event        String          // 'campaign.created', 'campaign.completed', 'lead.captured'
  payload      String          // JSON stringified event data
  status       String          // 'pending', 'success', 'failed'
  attempts     Int             @default(0)
  lastError    String?
  responseCode Int?            // HTTP status code from webhook URL
  
  createdAt    DateTime        @default(now())
  deliveredAt  DateTime?
  
  @@index([webhookId, status])
  @@index([createdAt])
}
