generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  name      String?
  plan      String     @default("FREE")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  analyses  Analysis[]
  payments  Payment[]
  conversations Conversation[]
  messages  Message[]
}

model Analysis {
  id              String   @id @default(uuid())
  userId          String
  creativeUrl     String?
  creativeType    String
  primaryText     String?
  headline        String?
  objective       String
  problemFaced    String
  whatChanged     String
  audienceType    String
  cpm             Float
  ctr             Float
  cpa             Float
  primaryReason   String
  supportingLogic String
  singleFix       String
  failureReason   String?
  resultType      String   @default("AVERAGE")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations   Conversation[]

  @@index([userId])
  @@index([objective])
  @@index([problemFaced])
  @@index([resultType])
}

model Payment {
  id                String   @id @default(uuid())
  userId            String
  razorpayOrderId   String   @unique
  razorpayPaymentId String?
  amount            Int
  currency          String   @default("INR")
  status            String   @default("PENDING")
  plan              String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Conversation {
  id         String    @id @default(uuid())
  userId     String
  title      String?
  analysisId String?
  goal       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis   Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)
  messages   Message[]

  @@index([userId, createdAt])
  @@index([analysisId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  role           String
  content        String
  feedback       String?
  createdAt      DateTime @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId, createdAt])
}
