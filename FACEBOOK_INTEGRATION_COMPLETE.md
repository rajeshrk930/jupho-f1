# Facebook Ad Account Integration - Setup Guide

## ğŸ‰ Implementation Complete!

I've successfully implemented the Facebook Ad Account integration for your Creative Failure Analyzer SaaS. Users can now connect their Facebook Ad Accounts and automatically fetch ad metrics instead of entering them manually.

## âœ… What's Been Implemented

### Phase 1: Database (Completed)
- âœ… Added `FacebookAccount` model to store user connections
- âœ… Added `FacebookAdCrdel to store ad data
- âœ… Updated `Analysis` model with `dataSource` field ('MANUAL' or 'FACEBOOK')
- âœ… Created database migration (fixed SQLite compatibility)

### Phase 2: Backend (Completed)
- âœ… Created `FacebookService` with:
  - OAuth token exchange
  - Token encryption/decryption
  - Ad account fetching
  - Active ads retrieval
  - Metrics fetching
  - Token refresh capability
- âœ… Created `facebook.routes.ts` with 7 endpoints:
  - `GET /api/facebook/auth-url` - Generate OAuth URL
  - `POST /api/facebook/callback` - Handle OAuth callback
  - `GET /api/facebook/status` - Check connection status
  - `DELETE /api/facebook/disconnect` - Disconnect account
  - `GET /api/facebook/ads` - Fetch active ads
  - `GET /api/facebook/ad/:adId` - Get specific ad metrics
  - `POST /api/facebook/refresh-token` - Refresh access token
- âœ… Updated `analysis.routes.ts` with:
  - `POST /api/analysis/from-facebook` - Analyze ad from Facebook
- âœ… Registered Facebook routes in backend index
- âœ… Added environment variables to `.env`

### Phase 3: Frontend (Completed)
- âœ… Updated Settings page with Facebook connection UI
- âœ… Created `FacebookAdSelector` component for ad selection
- âœ… Shows connection status, last sync time, token expiration warnings
- âœ… Connects/disconnects Facebook account

### Phase 4: Security & Configuration (Completed)
- âœ… Token encryption using AES-256-CBC
- âœ… View-only permissions (ads_read, read_insights)
- âœ… Secure token storage in database
- âœ… Token expiration handling (60 days)
- âœ… Environment variables configured

## ğŸ”§ Next Steps: Facebook App Setup

### 1. Create Facebook App

1. Go to [Facebook Developers](https://developers.facebook.com)
2. Click "My Apps" â†’ "Create App"
3. Select "Business" type
4. Fill in app details:
   - App Name: "Jupho Creative Analyzer"
   - App Contact Email: your-email@example.com
   - Business Account: Select your business

### 2. Add Products

1. **Facebook Login**:
   - Click "Add Product" â†’ Select "Facebook Login"
   - Click "Settings" under Facebook Login
   - Add Valid OAuth Redirect URIs:
     ```
     http://localhost:3000/auth/facebook/callback
     https://yourdomain.com/auth/facebook/callback
     ```
   - Save changes

2. **Marketing API**:
   - Click "Add Product" â†’ Select "Marketing API"
   - This gives you access to ad insights

### 3. Configure Permissions

1. Go to "App Review" â†’ "Permissions and Features"
2. Request these permissions:
   - `ads_read` (Standard Access)
   - `ads_management` (Standard Access)
   - `read_insights` (Standard Access)

### 4. Get App Credentials

1. Go to "Settings" â†’ "Basic"
2. Copy:
   - **App ID** â†’ This is your `FACEBOOK_APP_ID`
   - **App Secret** â†’ This is your `FACEBOOK_APP_SECRET`

### 5. Update Environment Variables

Update your `backend/.env` file:

```env
# Replace these with your actual Facebook app credentials
FACEBOOK_APP_ID=your_app_id_here
FACEBOOK_APP_SECRET=your_app_secret_here

# For local development
FACEBOOK_REDIRECT_URI=http://localhost:3000/auth/facebook/callback

# For production (update when deploying)
# FACEBOOK_REDIRECT_URI=https://yourdomain.com/auth/facebook/callback

# Already generated (don't change)
ENCRYPTION_KEY=<auto-generated-key>
```

### 6. Test in Development Mode

1. In Facebook App Settings â†’ "App Mode" â†’ Toggle to "Development"
2. Add test users in "Roles" â†’ "Test Users"
3. Make sure your Facebook account is added as a developer

### 7. Business Verification (Required for Production)

âš ï¸ **Important**: To use this in production with real users, you need:

1. **Business Verification**:
   - Go to "Settings" â†’ "Business Verification"
   - Submit required documents (business registration, etc.)
   - Typically takes 1-5 business days

2. **Advanced Access Request**:
   - After verification, request "Advanced Access" for `ads_read`
   - Provide use case explanation
   - Facebook will review (2-7 days)

3. **Switch to Live Mode**:
   - After approval, toggle "App Mode" to "Live"
   - Update `FACEBOOK_REDIRECT_URI` to production URL

## ğŸš€ How to Use

### For Users:

1. **Connect Facebook Account**:
   - Go to Settings page
   - Click "Connect Facebook"
   - Authorize the app (view-only access)
   - Select your ad account

2. **Analyze Facebook Ads** (Future Enhancement):
   - Go to Analyze page
   - Switch to "Facebook Ads" tab
   - Select an ad from your account
   - Automatically fetch metrics
   - Analyze without manual entry

## ğŸ“ Files Created/Modified

### Backend:
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ facebook.service.ts (NEW)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ facebook.routes.ts (NEW)
â”‚   â”‚   â””â”€â”€ analysis.routes.ts (MODIFIED)
â”‚   â””â”€â”€ index.ts (MODIFIED)
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma (MODIFIED)
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 20260109055858_add_facebook_integration/ (NEW)
â””â”€â”€ .env (MODIFIED)
```

### Frontend:
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ FacebookAdSelector.tsx (NEW)
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ settings/
â”‚           â””â”€â”€ page.tsx (MODIFIED)
```

## ğŸ” Security Features

- âœ… **Token Encryption**: All access tokens encrypted with AES-256-CBC
- âœ… **View-Only Access**: Only requests `ads_read` and `read_insights` permissions
- âœ… **Token Expiration**: Automatically tracks token expiry (60 days)
- âœ… **Secure Storage**: Encrypted tokens stored in database
- âœ… **HTTPS Required**: OAuth redirect requires HTTPS in production
- âœ… **No Ad Modification**: Cannot create, edit, or delete ads
- âœ… **User Control**: Users can disconnect anytime

## ğŸ“Š API Endpoints Summary

### Facebook Integration:
- `GET /api/facebook/auth-url` - Get OAuth URL for connection
- `POST /api/facebook/callback` - Handle OAuth callback
- `GET /api/facebook/status` - Check connection status
- `DELETE /api/facebook/disconnect` - Disconnect account
- `GET /api/facebook/ads` - Fetch all active ads
- `GET /api/facebook/ad/:adId` - Get specific ad metrics
- `POST /api/facebook/refresh-token` - Refresh expired token

### Analysis:
- `POST /api/analysis/from-facebook` - Analyze ad from Facebook (with automatic metrics)

## ğŸ¯ Future Enhancements (Optional)

1. **Analyze Page Integration**:
   - Add tab switcher: "Manual Entry" vs "Facebook Ads"
   - Use `FacebookAdSelector` component
   - Call `/api/analysis/from-facebook` endpoint

2. **Automatic Sync**:
   - Background job to refresh ads daily
   - Webhook for real-time updates

3. **Multiple Ad Accounts**:
   - Allow users to connect multiple accounts
   - Switch between accounts

4. **Historical Data**:
   - Show ad performance over time
   - Compare before/after changes

## âš ï¸ Important Notes

1. **Development vs Production**:
   - Development mode: Only works for app developers/testers
   - Production mode: Requires business verification + advanced access

2. **Rate Limits**:
   - Facebook Marketing API: 200 calls/hour per user
   - Implemented rate limiting in routes

3. **Token Refresh**:
   - Tokens expire after 60 days
   - Users will see warning 7 days before expiry
   - Need to reconnect if expired

4. **Data Compliance**:
   - Only store necessary data
   - Respect user privacy
   - Follow Facebook's Platform Terms

## ğŸ› Troubleshooting

### "Invalid OAuth Redirect URI"
- Ensure redirect URI in Facebook app matches exactly
- Check for trailing slashes
- Verify HTTPS in production

### "Insufficient Permissions"
- Check if `ads_read` permission is approved
- Verify user granted permissions during OAuth
- Check app is in correct mode (Development/Live)

### "Token Expired"
- User needs to reconnect account
- Implement automatic refresh (optional)

### "No Ad Accounts Found"
- User may not have Facebook Ad Account
- Check permissions on ad account
- Verify user's Business Manager access

## ğŸ“ Support

If you encounter issues:
1. Check Facebook App Dashboard for errors
2. Review backend logs for API errors
3. Verify environment variables are set
4. Test with Facebook's Graph API Explorer

## âœ¨ Summary

You now have a complete Facebook Ad Account integration! Users can:
- âœ… Connect their Facebook Ad Account securely
- âœ… View connection status in Settings
- âœ… Automatically fetch ad metrics (no manual entry)
- âœ… Disconnect anytime

The next step is to **create your Facebook App** and add the credentials to your `.env` file. Once done, users can start connecting their accounts!

Happy coding! ğŸš€
